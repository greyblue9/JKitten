#!/usr/local/bin/mksh-static-printf

for f in  /data/media/0/src/program_ab/src/bots/alice2/sets/*.txt; do fn="${f##*/}"; dir="${f: 0:${#f}-${#fn}}"; dir="${dir%%/}"; nme="${fn%.*}"; nme1="${nme%%s}"; nme1="${nme1%%es}"; tgt="/data/media/0/src/program_ab/src/bots/alice2/aiml/${nme1}.aiml"; [ -f "$tgt" ] && grep -Fe "generated from set" -- "$tgt" && rm -vf -- "$tgt"; [ -e "$tgt" ] && continue;  sed -r -e 's~^(.*)$~  <topic name="'"$nme1"'"><template><category>'"${nme1}"'</category><pattern>MY '"$nme"'</pattern><set name="it">\1</set></template></topic>~; 1i\<?xml version="1.0" encoding="utf-8"?>\n<aiml>\n  <!-- generated from set '"$f"' -->\n'  -e '$a\</aiml>' -- "$f" | mktee "$tgt"; done; for f in ./**/*.aiml; do dos2unix < "$f" | grep --line-buffered -C 88999 -Ee '.' --text --binary-files=without-match -hs | sed -r -e 's~\^M$~~g; s~\r~~g; \~M-gM-3M-~{ s~^.*$~rm -vf -- '"$f"'~e' -e '}' > /tmp/.tmp_aiml; xmllint --recover --format /tmp/.tmp_aiml > /tmp/.tmp_aiml2 && cat /tmp/.tmp_aiml2 > "$f"; done; cat update.aiml.csv | mktee /data/media/0/src/program_ab/src/bots/alice2/aimlif/update.aiml.csv; cat reductions_update.aiml.csv | mktee /data/media/0/src/program_ab/src/bots/alice2/aimlif/reductions_update.aiml.csv; NO_CACHE=1  findp  ./*/*/ "*.csv" -delete ;

